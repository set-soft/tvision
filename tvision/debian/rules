#!/usr/bin/make -f

version := $(shell cat version.txt)
package := rhtvision$(version)
destdir := $(shell pwd)/debian/tmp/usr

# Uncomment this to turn on verbose mode:
#export DH_VERBOSE=1

# Set CFLAGS, CXXFLAGS, etc.
DPKG_EXPORT_BUILDFLAGS := 1
include /usr/share/dpkg/default.mk

%:
	dh $@

override_dh_auto_clean: ../debianbackup.tar
	-git clean -dx --force

override_dh_auto_configure:
	./configure --prefix=$(destdir) --real-prefix=/usr \
		--libs-subdir=$(DEB_HOST_MULTIARCH) --fhs \
		--no-libs-here --with-debug

override_dh_auto_install:
	$(MAKE) install prefix=$(destdir)

override_dh_install:
	dh_movefiles -p $(package) usr/share/locale/ \
		usr/lib/$(DEB_HOST_MULTIARCH)/librhtv.so.$(version)
	dh_movefiles -p $(package)-dev usr/

override_dh_installdocs:
	dh_installdocs -A borland.txt copying copying.rh readme.txt \
		doc/CodePages.txt doc/ConfigFile.txt doc/Eterm.txt \
		doc/Linux.txt doc/X11.txt doc/XTerm.txt THANKS
	dh_installdocs -p $(package)-dev doc/TVReference.html \
		doc/I18n.txt doc/Streams.txt
	dh_installdocs -p $(package) extra/eterm/ debian/README.debian
	mv debian/$(package)/usr/share/doc/$(package)/README.debian \
		debian/$(package)/usr/share/doc/$(package)/README.Debian

override_dh_installexamples:
	dh_installexamples -p $(package)-dev examples/*

override_dh_installchangelogs:
	dh_installchangelogs change.log

override_dh_md5sums:
	# Clean up cvs/git files before checksumming
	find debian/$(package) debian/$(package)-dev \
		\( -name '.gitignore' -o -name '.cvsignore' \) -delete
	dh_md5sums

override_dh_makeshlibs:
	dh_makeshlibs -m$(version)

override_dh_builddeb:
	dh_builddeb
	# Restore files that were removed by git clean
	-tar -xf ../debianbackup.tar && rm -f ../debianbackup.tar

../debianbackup.tar:
	dh_testdir
	git clean -dx --exclude=debian/ --dry-run \
		| sed 's/Would remove //g' \
		| tar --files-from=- -cf $@
